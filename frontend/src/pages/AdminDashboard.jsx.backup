import React, { useState, useEffect } from 'react';
import { motion } from 'framer-motion';
import { useNavigate } from 'react-router-dom';
import axios from 'axios';
import ImageUpload from '../components/ImageUpload';

const AdminDashboard = () => {
  const navigate = useNavigate();
  const [activeTab, setActiveTab] = useState('programs'); // programs –∏–ª–∏ gallery
  const [programs, setPrograms] = useState([]);
  const [galleryItems, setGalleryItems] = useState([]);
  const [currentProgram, setCurrentProgram] = useState(null);
  const [currentGalleryItem, setCurrentGalleryItem] = useState(null);
  
  const [programFormData, setProgramFormData] = useState({
    title: '',
    description: '',
    duration: '',
    price: '',
    maxParticipants: '',
    imageUrl: '',
  });

  const [galleryFormData, setGalleryFormData] = useState({
    title: '',
    description: '',
    category: '–ò–Ω—Ç–µ—Ä—å–µ—Ä—ã',
    imageUrl: '',
    displayOrder: 0,
  });

  useEffect(() => {
    const token = localStorage.getItem('adminToken');
    if (!token) {
      navigate('/admin');
      return;
    }
    
    fetchPrograms();
    fetchGalleryItems();
  }, [navigate]);

  const fetchPrograms = async () => {
    try {
      const response = await axios.get('/api/programs');
      setPrograms(response.data);
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ–≥—Ä–∞–º–º:', error);
    }
  };

  const fetchGalleryItems = async () => {
    try {
      const token = localStorage.getItem('adminToken');
      const response = await axios.get('/api/gallery', {
        headers: { Authorization: `Bearer ${token}` }
      });
      setGalleryItems(response.data);
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≥–∞–ª–µ—Ä–µ–∏:', error);
    }
  };

  const handleLogout = () => {
    localStorage.removeItem('adminToken');
    navigate('/admin');
  };

  // === –ü–†–û–ì–†–ê–ú–ú–´ ===
  const handleEditProgram = (program) => {
    setCurrentProgram(program);
    setProgramFormData({
      title: program.title,
      description: program.description,
      duration: program.duration,
      price: program.price,
      maxParticipants: program.max_participants,
      imageUrl: program.image_url || '',
    });
  };

  const handleDeleteProgram = async (id) => {
    if (!window.confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É –ø—Ä–æ–≥—Ä–∞–º–º—É?')) {
      return;
    }

    try {
      const token = localStorage.getItem('adminToken');
      await axios.delete(`/api/programs/${id}`, {
        headers: { Authorization: `Bearer ${token}` }
      });
      fetchPrograms();
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è:', error);
      alert('–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –ø—Ä–æ–≥—Ä–∞–º–º—É');
    }
  };

  const handleProgramSubmit = async (e) => {
    e.preventDefault();

    try {
      const token = localStorage.getItem('adminToken');
      const config = {
        headers: { Authorization: `Bearer ${token}` }
      };

      if (currentProgram) {
        await axios.put(`/api/programs/${currentProgram.id}`, programFormData, config);
      } else {
        await axios.post('/api/programs', programFormData, config);
      }
      
      setCurrentProgram(null);
      setProgramFormData({
        title: '',
        description: '',
        duration: '',
        price: '',
        maxParticipants: '',
        imageUrl: '',
      });
      fetchPrograms();
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', error);
      alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–æ–≥—Ä–∞–º–º—É');
    }
  };

  const handleProgramChange = (e) => {
    const { name, value } = e.target;
    setProgramFormData(prev => ({
      ...prev,
      [name]: value
    }));
  };

  const handleProgramCancel = () => {
    setCurrentProgram(null);
    setProgramFormData({
      title: '',
      description: '',
      duration: '',
      price: '',
      maxParticipants: '',
      imageUrl: '',
    });
  };

  // === –ì–ê–õ–ï–†–ï–Ø ===
  const handleEditGalleryItem = (item) => {
    setCurrentGalleryItem(item);
    setGalleryFormData({
      title: item.title,
      description: item.description || '',
      category: item.category,
      imageUrl: item.image_url,
      displayOrder: item.display_order || 0,
    });
  };

  const handleDeleteGalleryItem = async (id) => {
    if (!window.confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —ç–ª–µ–º–µ–Ω—Ç?')) {
      return;
    }

    try {
      const token = localStorage.getItem('adminToken');
      await axios.delete(`/api/gallery/${id}`, {
        headers: { Authorization: `Bearer ${token}` }
      });
      fetchGalleryItems();
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è:', error);
      alert('–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —ç–ª–µ–º–µ–Ω—Ç');
    }
  };

  const handleGallerySubmit = async (e) => {
    e.preventDefault();

    try {
      const token = localStorage.getItem('adminToken');
      const config = {
        headers: { Authorization: `Bearer ${token}` }
      };

      if (currentGalleryItem) {
        await axios.put(`/api/gallery/${currentGalleryItem.id}`, galleryFormData, config);
      } else {
        await axios.post('/api/gallery', galleryFormData, config);
      }
      
      setCurrentGalleryItem(null);
      setGalleryFormData({
        title: '',
        description: '',
        category: '–ò–Ω—Ç–µ—Ä—å–µ—Ä—ã',
        imageUrl: '',
        displayOrder: 0,
      });
      fetchGalleryItems();
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', error);
      alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —ç–ª–µ–º–µ–Ω—Ç');
    }
  };

  const handleGalleryChange = (e) => {
    const { name, value } = e.target;
    setGalleryFormData(prev => ({
      ...prev,
      [name]: value
    }));
  };

  const handleGalleryCancel = () => {
    setCurrentGalleryItem(null);
    setGalleryFormData({
      title: '',
      description: '',
      category: '–ò–Ω—Ç–µ—Ä—å–µ—Ä—ã',
      imageUrl: '',
      displayOrder: 0,
    });
  };

  const categories = ['–ò–Ω—Ç–µ—Ä—å–µ—Ä—ã', '–≠–∫—Å–ø–æ–Ω–∞—Ç—ã', '–¢–µ–∫—Å—Ç–∏–ª—å', '–†–µ–º—ë—Å–ª–∞', '–ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è'];

  return (
    <div className="min-h-screen bg-cream-50 py-8">
      <div className="container mx-auto px-4">
        <div className="flex justify-between items-center mb-8">
          <h1 className="text-4xl font-display font-bold text-crimson-800">
            –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
          </h1>
          <button
            onClick={handleLogout}
            className="px-6 py-2 bg-crimson-700 text-white rounded-md hover:bg-crimson-800 transition-colors"
          >
            –í—ã–π—Ç–∏
          </button>
        </div>

        {/* –¢–∞–±—ã */}
        <div className="flex gap-4 mb-8">
          <button
            onClick={() => setActiveTab('programs')}
            className={`px-6 py-3 rounded-md font-semibold transition-all ${
              activeTab === 'programs'
                ? 'bg-crimson-700 text-white'
                : 'bg-white text-crimson-700 border-2 border-crimson-300'
            }`}
          >
            üìã –ü—Ä–æ–≥—Ä–∞–º–º—ã
          </button>
          <button
            onClick={() => setActiveTab('gallery')}
            className={`px-6 py-3 rounded-md font-semibold transition-all ${
              activeTab === 'gallery'
                ? 'bg-crimson-700 text-white'
                : 'bg-white text-crimson-700 border-2 border-crimson-300'
            }`}
          >
            üñºÔ∏è –ì–∞–ª–µ—Ä–µ—è
          </button>
        </div>

        {/* –ü–†–û–ì–†–ê–ú–ú–´ */}
        {activeTab === 'programs' && (
          <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div className="lg:col-span-1">
              <motion.div
                initial={{ opacity: 0, x: -30 }}
                animate={{ opacity: 1, x: 0 }}
                className="folk-card p-6 sticky top-8"
              >
                <h2 className="text-2xl font-display font-bold text-crimson-800 mb-6">
                  {currentProgram ? '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–≥—Ä–∞–º–º—É' : '–ù–æ–≤–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞'}
                </h2>

                <form onSubmit={handleProgramSubmit} className="space-y-4">
                  <ImageUpload
                    currentImage={programFormData.imageUrl}
                    onImageUploaded={(url) => setProgramFormData(prev => ({ ...prev, imageUrl: url }))}
                    type="programs"
                  />

                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">–ù–∞–∑–≤–∞–Ω–∏–µ *</label>
                    <input
                      type="text"
                      name="title"
                      required
                      value={programFormData.title}
                      onChange={handleProgramChange}
                      className="w-full px-4 py-2 border-2 border-crimson-300 rounded-md focus:border-crimson-600 focus:ring-2 focus:ring-crimson-200"
                    />
                  </div>

                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">–û–ø–∏—Å–∞–Ω–∏–µ *</label>
                    <textarea
                      name="description"
                      required
                      rows="4"
                      value={programFormData.description}
                      onChange={handleProgramChange}
                      className="w-full px-4 py-2 border-2 border-crimson-300 rounded-md focus:border-crimson-600 focus:ring-2 focus:ring-crimson-200 resize-none"
                    ></textarea>
                  </div>

                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å *</label>
                    <input
                      type="text"
                      name="duration"
                      required
                      value={programFormData.duration}
                      onChange={handleProgramChange}
                      placeholder="2 —á–∞—Å–∞"
                      className="w-full px-4 py-2 border-2 border-crimson-300 rounded-md focus:border-crimson-600 focus:ring-2 focus:ring-crimson-200"
                    />
                  </div>

                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">–¶–µ–Ω–∞ *</label>
                    <input
                      type="text"
                      name="price"
                      required
                      value={programFormData.price}
                      onChange={handleProgramChange}
                      placeholder="500 —Ä—É–±/—á–µ–ª"
                      className="w-full px-4 py-2 border-2 border-crimson-300 rounded-md focus:border-crimson-600 focus:ring-2 focus:ring-crimson-200"
                    />
                  </div>

                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">–ú–∞–∫—Å. —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ *</label>
                    <input
                      type="number"
                      name="maxParticipants"
                      required
                      min="1"
                      value={programFormData.maxParticipants}
                      onChange={handleProgramChange}
                      className="w-full px-4 py-2 border-2 border-crimson-300 rounded-md focus:border-crimson-600 focus:ring-2 focus:ring-crimson-200"
                    />
                  </div>

                  <div className="flex gap-2">
                    <button
                      type="submit"
                      className="flex-1 px-4 py-2 bg-crimson-700 text-white rounded-md hover:bg-crimson-800 transition-colors font-semibold"
                    >
                      {currentProgram ? '–û–±–Ω–æ–≤–∏—Ç—å' : '–î–æ–±–∞–≤–∏—Ç—å'}
                    </button>
                    {currentProgram && (
                      <button
                        type="button"
                        onClick={handleProgramCancel}
                        className="px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400 transition-colors"
                      >
                        –û—Ç–º–µ–Ω–∞
                      </button>
                    )}
                  </div>
                </form>
              </motion.div>
            </div>

            <div className="lg:col-span-2">
              <h2 className="text-2xl font-display font-bold text-crimson-800 mb-6">–°–ø–∏—Å–æ–∫ –ø—Ä–æ–≥—Ä–∞–º–º</h2>
              <div className="space-y-4">
                {programs.map((program) => (
                  <div key={program.id} className="folk-card p-6">
                    <div className="flex gap-4">
                      {program.image_url && (
                        <img
                          src={program.image_url}
                          alt={program.title}
                          className="w-32 h-32 object-cover rounded-lg flex-shrink-0"
                        />
                      )}
                      <div className="flex-1">
                        <div className="flex justify-between items-start mb-4">
                          <h3 className="text-xl font-display font-bold text-crimson-800">
                            {program.title}
                          </h3>
                          <div className="flex gap-2">
                            <button
                              onClick={() => handleEditProgram(program)}
                              className="px-4 py-2 bg-gold-500 text-crimson-900 rounded-md hover:bg-gold-400 transition-colors text-sm font-semibold"
                            >
                              ‚úèÔ∏è
                            </button>
                            <button
                              onClick={() => handleDeleteProgram(program.id)}
                              className="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition-colors text-sm font-semibold"
                            >
                              üóëÔ∏è
                            </button>
                          </div>
                        </div>
                        <p className="text-gray-700 mb-4">{program.description}</p>
                        <div className="flex flex-wrap gap-4 text-sm text-gray-600">
                          <span>‚è±Ô∏è {program.duration}</span>
                          <span>üí∞ {program.price}</span>
                          <span>üë• –¥–æ {program.max_participants} —á–µ–ª</span>
                        </div>
                      </div>
                    </div>
                  </div>
                ))}
              </div>
            </div>
          </div>
        )}

        {/* –ì–ê–õ–ï–†–ï–Ø */}
        {activeTab === 'gallery' && (
          <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div className="lg:col-span-1">
              <motion.div
                initial={{ opacity: 0, x: -30 }}
                animate={{ opacity: 1, x: 0 }}
                className="folk-card p-6 sticky top-8"
              >
                <h2 className="text-2xl font-display font-bold text-crimson-800 mb-6">
                  {currentGalleryItem ? '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —ç–ª–µ–º–µ–Ω—Ç' : '–ù–æ–≤—ã–π —ç–ª–µ–º–µ–Ω—Ç –≥–∞–ª–µ—Ä–µ–∏'}
                </h2>

                <form onSubmit={handleGallerySubmit} className="space-y-4">
                  <ImageUpload
                    currentImage={galleryFormData.imageUrl}
                    onImageUploaded={(url) => setGalleryFormData(prev => ({ ...prev, imageUrl: url }))}
                    type="gallery"
                  />

                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">–ù–∞–∑–≤–∞–Ω–∏–µ *</label>
                    <input
                      type="text"
                      name="title"
                      required
                      value={galleryFormData.title}
                      onChange={handleGalleryChange}
                      className="w-full px-4 py-2 border-2 border-crimson-300 rounded-md focus:border-crimson-600 focus:ring-2 focus:ring-crimson-200"
                    />
                  </div>

                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                    <textarea
                      name="description"
                      rows="3"
                      value={galleryFormData.description}
                      onChange={handleGalleryChange}
                      className="w-full px-4 py-2 border-2 border-crimson-300 rounded-md focus:border-crimson-600 focus:ring-2 focus:ring-crimson-200 resize-none"
                    ></textarea>
                  </div>

                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">–ö–∞—Ç–µ–≥–æ—Ä–∏—è *</label>
                    <select
                      name="category"
                      required
                      value={galleryFormData.category}
                      onChange={handleGalleryChange}
                      className="w-full px-4 py-2 border-2 border-crimson-300 rounded-md focus:border-crimson-600 focus:ring-2 focus:ring-crimson-200"
                    >
                      {categories.map(cat => (
                        <option key={cat} value={cat}>{cat}</option>
                      ))}
                    </select>
                  </div>

                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">–ü–æ—Ä—è–¥–æ–∫ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</label>
                    <input
                      type="number"
                      name="displayOrder"
                      value={galleryFormData.displayOrder}
                      onChange={handleGalleryChange}
                      className="w-full px-4 py-2 border-2 border-crimson-300 rounded-md focus:border-crimson-600 focus:ring-2 focus:ring-crimson-200"
                    />
                  </div>

                  <div className="flex gap-2">
                    <button
                      type="submit"
                      className="flex-1 px-4 py-2 bg-crimson-700 text-white rounded-md hover:bg-crimson-800 transition-colors font-semibold"
                    >
                      {currentGalleryItem ? '–û–±–Ω–æ–≤–∏—Ç—å' : '–î–æ–±–∞–≤–∏—Ç—å'}
                    </button>
                    {currentGalleryItem && (
                      <button
                        type="button"
                        onClick={handleGalleryCancel}
                        className="px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400 transition-colors"
                      >
                        –û—Ç–º–µ–Ω–∞
                      </button>
                    )}
                  </div>
                </form>
              </motion.div>
            </div>

            <div className="lg:col-span-2">
              <h2 className="text-2xl font-display font-bold text-crimson-800 mb-6">–≠–ª–µ–º–µ–Ω—Ç—ã –≥–∞–ª–µ—Ä–µ–∏</h2>
              <div className="grid grid-cols-2 gap-4">
                {galleryItems.map((item) => (
                  <div key={item.id} className="folk-card overflow-hidden group">
                    <div className="relative">
                      <img
                        src={item.image_url}
                        alt={item.title}
                        className="w-full h-48 object-cover"
                      />
                      <div className="absolute top-2 right-2 flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                        <button
                          onClick={() => handleEditGalleryItem(item)}
                          className="p-2 bg-gold-500 text-crimson-900 rounded-full hover:bg-gold-400"
                        >
                          ‚úèÔ∏è
                        </button>
                        <button
                          onClick={() => handleDeleteGalleryItem(item.id)}
                          className="p-2 bg-red-600 text-white rounded-full hover:bg-red-700"
                        >
                          üóëÔ∏è
                        </button>
                      </div>
                    </div>
                    <div className="p-4">
                      <h3 className="font-display font-bold text-crimson-800 mb-1">{item.title}</h3>
                      <p className="text-sm text-gray-600">{item.category}</p>
                    </div>
                  </div>
                ))}
              </div>
            </div>
          </div>
        )}
      </div>
    </div>
  );
};

export default AdminDashboard;